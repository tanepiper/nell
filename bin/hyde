#!/usr/bin/env node

/*
 * hyde
 * https://github.com/tanepiper/hyde
 *
 * Copyright (c) 2012 Tane Piper
 * Licensed under the MIT license.
 * https://github.com/tanepiper/hyde/blob/master/LICENSE-MIT
 */

'use strict';

var fs = require('fs');
var path = require('path');
var util = require('util');
var winston = require('winston');
var program = require('commander');

require('colorful').colorful();

var pkg = require(__dirname + '/../package.json');
var site_path = process.cwd();

var logger = new(winston.Logger)({
  transports: [
    new (winston.transports.Console)(),
    new winston.transports.File({ filename: path.join(__dirname, '..', 'hyde.debug.log') })
  ]
});

var done = function(err, results) {
  if (err) {
    logger.error( util.format('%s', err).to.red.color);
    return program.help();
  }
  if (results) {
    logger.info( util.format('%s', results).to.blue.color);
  }
};

var processCommand = function(command) {
  if (command.indexOf('.js') !== -1) {
    command = command.replace('.js', '');
    var createCommand = function(command_name) {
      var command = require( path.join(__dirname, '..', 'lib', command_name) );
      var command_line = util.format('%s %s', command.key, command.args);
      program
        .command(command_line)
        .description(command.desc)
        .action(function(args, cmd) {
          if (command.args && typeof args === 'undefined') {
            if (!command.default) {
              return done( new Error(util.format('You have not passed the %s argument for command %s', command.args, command.key)));
            } 
            args = command.default;
          }
          command.run(site_path, args, cmd, done);
        });
    };
    return createCommand(command);
  }
  return false;
};

program.version(pkg.version);

fs.readdirSync( path.join(__dirname, '..', 'lib') ).forEach(processCommand);

program.parse(process.argv);